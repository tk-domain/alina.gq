/*
	External callbacks
*/

function SyncR_Callback(_ruid) {
	window['rnetplus_acqPt'](_ruid);
	//window['rnetplus_acqPt'] = null;
}

function acquirePortraitCallbackFunc(result) { 
	window['rnetplus_acqPtCb'](result);
}

/* Main code */

(function () {
	var curScript = document.currentScript;
	if (!curScript) {
		var scripts = document.getElementsByTagName('script');
		for(var jk = scripts.length - 1; jk >= 0; --jk) {
			if (scripts[jk].src.indexOf('api.min.js') > 0) {
				consumeCurScript(scripts[jk]);
				break;
			}
			else if (scripts[jk].src.indexOf('api.js') > 0) {
				consumeCurScript(scripts[jk]);
				break;
			}
		}
	}
	else
		consumeCurScript(curScript);

	function derefFunctionByName(functionName, context) {
		if (!functionName)  return null;

		var namespaces = functionName.split(".");
		var func = namespaces.pop();
		for(var i = 0; i < namespaces.length; i++) 
			context = context[namespaces[i]];
		return {ctx: context, fn: context[func], name: func };
	}

	function executeFunctionByDeref(functionCtx, arg, asyncCallFlag) {
		var retn = functionCtx.fn.apply(functionCtx.ctx, [arg, asyncCallFlag]);
		return retn;
	}

	function consumeCurScript(curScript) {
		var href = curScript.src;

		var mapV = {};
		href.split('?')[1].split('&').forEach(function(item) {
			var arr = item.split('=');
			mapV[arr[0]] = arr[1];
		});

		var callbackFunc = derefFunctionByName(mapV["callback"], window);

	    window['rnetplus_acqPtCbUbCtx'] = window['rnetplus_acqPtCbUbCtx'] || [];
    	window['rnetplus_acqPtCbUbCtx'].push(callbackFunc);
	}

	/*
	 * User management
	*/
	var app_id_bacon = "a8422396-8b51-4eb1-a7b2-163540ede795";
	var app_id = "rnetplus";

    var userIdKey = "RamblerExchangeUserId";
    var userId = "";
    var ruid = "";
    var stamp= Math.round(new Date().getTime()/1000);
    var portrait = "";
    var uniq = false;

    window['rnetplus_acqPt'] = acquirePortrait;
    window['rnetplus_acqPtCb'] = acquirePortraitImpl;
    window['rnetplus_acqPtQ'] = window['rnetplus_acqPtQ'] || [];

    var uuid = function () {
        return 'xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx'.replace(/[x]/g, function (z) {
            var rnd = Math.random() * 16 | 0, v = z == 'x' ? rnd : (rnd & 0x3 | 0x8);
            return v.toString(16);
        });
    };

	function onApiDataLoadedCallback (data, flag) {
		data.screen = "" + window.screen.width + "x" + window.screen.height;
		data.urlParams = "screen="+data.screen + "&user_id=" + data.uid + "&rp=" + data.rp;
		// console.log("Rnet+: " + data.urlParams);
		if (window['rnetplus_acqPtCbUbCtx']) {
			var array = [];
			for(var j = 0; j < window['rnetplus_acqPtCbUbCtx'].length; ++j) {
				var callbackFunc = window['rnetplus_acqPtCbUbCtx'][j];
				if (callbackFunc) array.push(callbackFunc);
				// window['rnetplus_acqPtCbUbCtx'][j] = null;
				// if (callbackFunc) console.log("Rnet+: " + callbackFunc.name);
			}
			for(var j = 0; j < array.length; ++j) 
				executeFunctionByDeref(array[j], data, flag);
		}
	}

    // function xlog(s) { console.log(window.location + ": " + s); }

    if (window.localStorage) {
        userId = window.localStorage.getItem(userIdKey);
        if (!userId || userId == '{}') {
            userId = uuid();
            uniq = true;
            window.localStorage.setItem(userIdKey, userId);
        }

        var oldstamp = window.localStorage.getItem(userIdKey + ".ruid.stamp");
        if (oldstamp && parseInt(oldstamp) + 24 * 3600 < stamp) {
	        window.localStorage.removeItem(userIdKey + ".ruid");
    	    window.localStorage.removeItem(userIdKey + ".ruid.stamp");
    	    window.localStorage.removeItem(userIdKey + ".ruid.rp");
        }
        ruid = window.localStorage.getItem(userIdKey + ".ruid");
	    portrait = window.localStorage.getItem(userIdKey + ".ruid.rp");
    }

    if (!window.localStorage || window.localStorage.getItem(userIdKey) != userId) {
    	// welcome private browsing
    	if (window["rnetplus_acqPt_Guid"]) 
    		userId = window["rnetplus_acqPt_Guid"];
    	else
    		window["rnetplus_acqPt_Guid"] = userId;
    	portrait = "";
    	ruid = "---";
    }

    function getUserId () { return userId; }
    function getPortrait () { return portrait; }
    function getRuId () { 
    	if(ruid == "null" || ruid == "" || ruid == "KgAAAPfwGFhuL9dlAQyTBAB=") ruid = null; 
    	return ruid; 
    }

    /*
     * Digital portrait dances: 1x1px image
     * How it works: sync.rambler.ru redirects to /service/syncr?ruid=...
     * And then /service/syncr returns script calling SyncR_Callback(ruid)
    */
    function wireUserIds() {
    	/*
		var img = new Image();
		img.src = "https://sync.rambler.ru/set?partner_id="+app_id+"&id=" + getUserId() + "&dt=" + Math.round(new Date().getTime()/1000);
		*/

		if (window.wireUserIdsInProgress)  return;
		window.wireUserIdsInProgress = true;

    	var scriptVsAjax = document.createElement('script');
    	scriptVsAjax.src = decodeURIComponent(
    		"https://sync.rambler.ru/emily?partner_id=" + app_id_bacon
			+ "&id=" + getUserId() 
			+ "&dt=" + new Date().getTime()
			);

		scriptVsAjax.onerror = function() { // server returned bad-ass response
			acquirePortrait('---');
		}

		/*scriptVsAjax.onload = function() {
			if(window['rnetplus_acqPt']) 
				window['rnetplus_acqPt']('---');
		}*/
    	document.getElementsByTagName("head")[0].appendChild(scriptVsAjax); 
    }

    function pushBackLoads(_rp) {
    	var arr = window['rnetplus_acqPtQ'];
    	if (arr != null && arr.length > 0) {
	    	for(var j=0; j < arr.length; ++j) {
    			var data = window['rnetplus_acqPtQ'][j];
    			data.rp = _rp;
    			onApiDataLoadedCallback(data, true);
    		}
    	}
    	else {
		    onApiDataLoadedCallback({uid: getUserId(), rp: _rp, u: uniq}, true);
    	}
    }

    function acquirePortrait (_ruid) {
	    if (_ruid == '---') {
	    	pushBackLoads('');
	    	return;
	    }
	    
	    if (window.localStorage) {
    	    window.localStorage.setItem(userIdKey + ".ruid", _ruid);
        	window.localStorage.setItem(userIdKey + ".ruid.stamp", Math.round(new Date().getTime()/1000));
	    }
	    ruid = _ruid;

    	if (!_ruid) _ruid = "KgAAAPfwGFhuL9dlAQyTBAB=";
		var script = document.createElement('script');
		script.src = "https://bacon.rambler.ru/api/data/v1.5/user.get?" 
			+ "app_id=" + app_id_bacon + "&callback=acquirePortraitCallbackFunc"
			+ "&ruid="  + _ruid;
		document.getElementsByTagName("head")[0].appendChild(script); 
    }

	function acquirePortraitImpl(result) { 
		/* result means the data from portrait description */
		/* {"data":[{"id":"1","segment":[]}]} */
		/* {"data":[{"id": "1","segment": [
			{"id": "5","lm": 1342722630,"prob": 0.9},
        	{"id": "8","lm": 1342722400,"prob": 0.8}]}]}*/
		var categories = result.data;
		var i, j;
		portrait = '';
		for(i=0; i < categories.length; ++i) {
			var segments = categories[i].segment;
			var ss = '';
			for(j=0; j < segments.length; ++j) {
				if(segments[j].prob && parseFloat(segments[j].prob) < 0.7) continue;
				if(ss.length > 0) ss += ',';
				ss += segments[j].id;
			}
			if(ss.length == 0) continue;
			if (portrait.length > 0) portrait += ';';
			portrait += ss;
		}

	    if (window.localStorage) {
	        window.localStorage.setItem(userIdKey + ".ruid.rp", portrait);
	    }
	    window.wireUserIdsInProgress = false;
	    pushBackLoads(portrait);
	}

	var data = {uid: getUserId(), rp: getPortrait(), u: uniq};
    if (!getRuId()) {
    	window['rnetplus_acqPtQ'].push(data);
    	wireUserIds (); // we have no cached value -> get it first
    }
    else
    	onApiDataLoadedCallback(data, false);
})();
